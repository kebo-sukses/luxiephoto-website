<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Authorizing...</title>
</head>
<body>
  <p>Processing authentication...</p>
  <script>
    (function() {
      var code = new URLSearchParams(window.location.search).get('code');
      
      if (!code) {
        document.body.innerHTML = '<h1>Error: No authorization code found</h1>';
        return;
      }

      // Exchange code for token via Netlify function
      fetch('https://dancing-squirrel-226937.netlify.app/.netlify/functions/callback?code=' + code, {
        headers: { 'Accept': 'application/json' }
      })
      .then(function(response) { return response.json(); })
      .then(function(data) {
        if (data.error) {
          document.body.innerHTML = '<h1>Error: ' + data.error + '</h1>';
          return;
        }

        var token = data.token;
        
        // Send message to parent window (Decap CMS)
        function receiveMessage(e) {
          window.opener.postMessage(
            'authorization:github:success:{"token":"' + token + '","provider":"github"}',
            e.origin
          );
          window.removeEventListener("message", receiveMessage, false);
          setTimeout(function() { window.close(); }, 1000);
        }
        
        window.addEventListener("message", receiveMessage, false);
        
        // Initiate handshake with parent window
        window.opener.postMessage("authorizing:github", "*");
        
        document.body.innerHTML = '<p>Authorization successful! This window will close automatically...</p>';
      })
      .catch(function(error) {
        document.body.innerHTML = '<h1>Error: ' + error.message + '</h1>';
      });
    })();
  </script>
</body>
</html>
